name: Publish GitHub release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      tag:
        description: "Release tag (for example: v1.2.3)"
        required: true
        type: string
      generate_notes:
        description: Auto-generate release notes
        required: false
        default: true
        type: boolean

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Resolve tag
        id: vars
        shell: bash
        run: |
          set -euo pipefail

          if [[ "${GITHUB_EVENT_NAME}" == "workflow_dispatch" ]]; then
            TAG="${{ inputs.tag }}"
            GENERATE_NOTES="${{ inputs.generate_notes }}"
          else
            TAG="${GITHUB_REF_NAME}"
            GENERATE_NOTES="true"
          fi

          if [[ "${TAG}" != v* ]]; then
            echo "Tag must start with v (got: ${TAG})"
            exit 1
          fi

          echo "tag=${TAG}" >> "$GITHUB_OUTPUT"
          echo "generate_notes=${GENERATE_NOTES}" >> "$GITHUB_OUTPUT"

      - name: Create or update release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.vars.outputs.tag }}
          generate_release_notes: ${{ steps.vars.outputs.generate_notes == 'true' }}
