name: Build release packages

on:
  workflow_dispatch:
  push:
    branches:
      - main
      - release-*.*.*
    tags:
      - 'v*'

concurrency:
  group: release-build-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: read
  packages: write

jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      commit: ${{ steps.commit.outputs.commit }}
    steps:
      - uses: actions/checkout@v5
        with:
          persist-credentials: false

      - id: version
        name: Resolve version
        shell: bash
        run: |
          set -euo pipefail

          if [[ "${GITHUB_REF}" == refs/tags/v* ]]; then
            VERSION="${GITHUB_REF_NAME#v}"
          elif [[ "${GITHUB_REF_NAME}" == release-* ]]; then
            VERSION="${GITHUB_REF_NAME#release-}"
          else
            VERSION="$(jq -r .version package.json | sed -e "s/pre/${GITHUB_RUN_ID}/g")"
          fi

          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "VERSION=${VERSION}" >> "$GITHUB_ENV"
          printf '%s\n' "${VERSION}" > VERSION

      - id: commit
        run: echo "commit=$(git rev-parse HEAD)" >> "$GITHUB_OUTPUT"

  build:
    runs-on: ubuntu-latest
    needs: setup
    name: ${{ needs.setup.outputs.version }} / linux-amd64
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v5
        with:
          persist-credentials: false

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Build package artifacts
        id: build
        uses: ./.github/actions/build-package
        with:
          artifacts: targz:grafana:linux/amd64,deb:grafana:linux/amd64,rpm:grafana:linux/amd64,docker:grafana:linux/amd64
          checksum: true
          grafana-path: .
          github-token: ${{ secrets.GITHUB_TOKEN }}
          version: ${{ needs.setup.outputs.version }}
          output: artifacts-linux-amd64.txt
          verify: false
          build-id: ${{ github.run_id }}

      - name: Upload artifact list
        uses: actions/upload-artifact@v4
        with:
          name: artifacts-list-linux-amd64
          path: ${{ steps.build.outputs.file }}
          retention-days: 7

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: artifacts-linux-amd64
          path: ${{ steps.build.outputs.dist-dir }}
          retention-days: 7

  publish-image:
    if: github.ref_name == 'main' || startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    needs:
      - setup
      - build
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: artifacts-list-linux-amd64
          path: .

      - uses: actions/download-artifact@v4
        with:
          name: artifacts-linux-amd64
          path: dist

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Load and push image
        shell: bash
        env:
          VERSION: ${{ needs.setup.outputs.version }}
          REF_NAME: ${{ github.ref_name }}
          REPOSITORY_OWNER: ${{ github.repository_owner }}
        run: |
          set -euo pipefail

          cat artifacts-*.txt > artifacts.txt

          DOCKER_TARS="$(grep 'grafana_.*docker.tar.gz$' artifacts.txt || true)"
          if [[ -z "${DOCKER_TARS}" ]]; then
            DOCKER_TARS="$(find dist -type f -name '*docker.tar.gz' | sort)"
          fi

          if [[ -z "${DOCKER_TARS}" ]]; then
            echo "No docker artifact found."
            exit 1
          fi

          : > loaded_images.txt
          while IFS= read -r tarfile; do
            [[ -z "${tarfile}" ]] && continue
            docker load -i "${tarfile}" | sed 's/Loaded image: //g' | tee -a loaded_images.txt
          done <<< "${DOCKER_TARS}"

          SOURCE_IMAGE="$(head -n1 loaded_images.txt | tr -d '[:space:]')"
          if [[ -z "${SOURCE_IMAGE}" ]]; then
            echo "Failed to resolve loaded docker image name."
            exit 1
          fi

          OWNER_LOWER="$(echo "${REPOSITORY_OWNER}" | tr '[:upper:]' '[:lower:]')"
          TARGET_IMAGE="ghcr.io/${OWNER_LOWER}/grafnaut"

          docker tag "${SOURCE_IMAGE}" "${TARGET_IMAGE}:${VERSION}"
          docker push "${TARGET_IMAGE}:${VERSION}"

          if [[ "${REF_NAME}" == "main" ]]; then
            docker tag "${SOURCE_IMAGE}" "${TARGET_IMAGE}:latest"
            docker push "${TARGET_IMAGE}:latest"
          fi

          echo "Published ${TARGET_IMAGE}:${VERSION}"
