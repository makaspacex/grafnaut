name: Frontend lint and typecheck

on:
  pull_request:

permissions: {}

jobs:
  detect-changes:
    name: Detect frontend changes
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      changed: ${{ steps.detect-changes.outputs.frontend }}
      prettier: ${{ steps.detect-changes.outputs.frontend == 'true' || steps.detect-changes.outputs.docs == 'true' }}
    steps:
      - uses: actions/checkout@v5
        with:
          persist-credentials: true
          fetch-depth: 2
      - name: Detect changes
        id: detect-changes
        uses: ./.github/actions/change-detection
        with:
          self: .github/workflows/frontend-lint.yml

  frontend-lint:
    needs: detect-changes
    if: needs.detect-changes.outputs.changed == 'true' || needs.detect-changes.outputs.prettier == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v5
        with:
          persist-credentials: false

      - name: Setup Node.js
        uses: ./.github/actions/setup-node

      - name: Install dependencies
        run: yarn install --immutable --check-cache

      - name: Prettier check
        run: yarn run prettier:check

      - name: Lint, typecheck and verify generated API clients
        shell: bash
        run: |
          set -euo pipefail

          if [[ "${{ needs.detect-changes.outputs.changed }}" != "true" ]]; then
            echo "Only docs changed, skip frontend lint/typecheck/API checks."
            exit 0
          fi

          yarn run lint
          yarn run typecheck
          yarn generate-apis

          FILE_DIFF="$(git diff ':!conf')"
          if [[ -n "${FILE_DIFF}" ]]; then
            echo "ERROR: generated API clients are not committed."
            echo "${FILE_DIFF}"
            exit 1
          fi
